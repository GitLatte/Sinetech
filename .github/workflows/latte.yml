name: ğŸ› ï¸OluÅŸtur ve â™»ï¸ GÃ¼ncelle

on:
  workflow_dispatch:        # Manuel tetiklemek iÃ§in
  push:                     # AÅŸaÄŸÄ±daki branch'lara push olursa otomatik tetikler
    branches:
      - main
      - builds

jobs:
  sync_plugins:
    runs-on: ubuntu-latest

    steps:
      - name: ğŸ“Kendi deposunu Ã§ek
        uses: actions/checkout@v4
        with:
          ref: builds
          token: ${{ secrets.ACTIONHELPER }}

      - name: ğŸ—£ï¸ Gizli depoyu Ã¶zel klasÃ¶re Ã§ek
        uses: actions/checkout@v4
        with:
          repository: ${{ secrets.PRIVATE_REPO_OWNER }}/${{ secrets.PRIVATE_REPO_NAME }}
          ref: builds
          token: ${{ secrets.LATTE_PAT }}
          path: private_repo

      - name: ğŸ” Gizli depodaki dosyalarÄ± listele
        run: ls -la private_repo

      - name: ğŸ—ƒï¸ .cs3 ve plugins.json dosyalarÄ±nÄ± kopyala
        run: |
          cp private_repo/*.cs3 ./ || echo "HiÃ§ .cs3 dosyasÄ± bulunamadÄ±!"
          cp private_repo/plugins.json ./ || echo "plugins.json dosyasÄ± bulunamadÄ±!"

      - name: ğŸ  Ana dizindeki dosyalarÄ± kontrol et
        run: ls -la

      - name: ğŸ“œ plugins.json iÃ§indeki repo adreslerini gÃ¼ncelle
        run: |
          OLD_REPO_NAME="${{ secrets.PRIVATE_REPO_OWNER }}/${{ secrets.PRIVATE_REPO_NAME }}"
          NEW_REPO_NAME="${{ github.repository }}"
          PUBLIC_REPO_URL="https://raw.githubusercontent.com/${NEW_REPO_NAME}"
          PUBLIC_REPO_GH_URL="https://github.com/${NEW_REPO_NAME}"

          if [ -f plugins.json ]; then
            sed -i "s|https://raw.githubusercontent.com/${OLD_REPO_NAME}|${PUBLIC_REPO_URL}|g" plugins.json
            sed -i "s|https://github.com/${OLD_REPO_NAME}|${PUBLIC_REPO_GH_URL}|g" plugins.json
          else
            echo "plugins.json bulunamadÄ±ÄŸÄ± iÃ§in gÃ¼ncelleme yapÄ±lmadÄ±!"
          fi

      - name: ğŸ‘©ğŸ»â€ğŸ’» DeÄŸiÅŸiklikleri commit'le ve push'la
        run: |
          git config --local user.email "212895703+ActionHelper@users.noreply.github.com"
          git config --local user.name "ActionHelper"
          git rm --ignore-unmatch --cached private_repo
          if [ -f plugins.json ]; then
            git add *.cs3 plugins.json
          else
            git add *.cs3
          fi
          git diff-index --quiet HEAD || git commit -m "ğŸ•Šï¸ eklentiler gÃ¼ncellendi."
          git remote set-url origin https://x-access-token:${{ secrets.ACTIONHELPER }}@github.com/${{ github.repository }}.git
          git push origin builds
          
